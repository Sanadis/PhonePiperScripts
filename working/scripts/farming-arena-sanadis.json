//@formatter:off
{
"vars": [],
"imports": [
  "ayaka",
//  "veritas",
//  "orlandeau",
  "malphasie",
//  "rinoa",
//  "barbariccia",
  "lilith"
//  "freyvia",
//  "rinoa"
],
"states": {

//  "_arena-menu-opponent-select": {
//  "statements" : [{
//      "condition": {
//        "is": "SCREEN", "value": "menu-arena-opponent_select"
//      },
//      "actions": [{
//        "type": "SLOW_UP", "value": "menu-arena-opponent_drag"}, {
//        "type": "SLOW_UP", "value": "menu-arena-opponent_drag"}, {
//        "type": "SLOW_UP", "value": "menu-arena-opponent_drag"}, {
//        "type": "TAP", "value": "menu-arena-opponent_first"}, {
//        "type": "WAIT", "value": "2000"}, {
//        "type": "REPEAT", "value": ""}
//      ]
//    }]
//  },

  "arena-battle-setup": {
    "name": "Arena - Battle - Setup (Override)",
    "description":"Setup each unit and start the fight",
    "includes": [
      "_arena-battle-lb",
      "_arena-battle-f",
      "_arena-battle-fight",
      "_common-no_op"
    ],
    "variables": {
       "index_lilith1": {"value": "0", "type": "INT"},
       "index_lilith2": {"value": "1", "type": "INT"},
       "index_malphasie1": {"value": "2", "type": "INT"},
       "index_malphasie2": {"value": "3", "type": "INT"},
       "index_ayaka": {"value": "4", "type": "INT"},

       "stage": {"value": "0", "type": "INT"},
       "arena_turn": {"value": "1", "type": "INT"}
    },
    "statements": [{

      "condition": {
        "is": "CALL", "value": "@isBattleReady",
        "and": [{
          "is": "LESS", "value": "5", "var": "stage"}, {
          "is": "GREATER", "value": "20", "var": "_loops" }
        ]
      },
      "actions": [{
        "type": "INFO", "value": "Unit stuck on stage ${stage}, incrementing counter"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "ADD", "value": "1", "var": "stage"}, {
        "type": "REPEAT", "value": ""}
      ]

    }, {

      "condition": {
        "is"    : "SCREEN", "value" : "game-battle",
        "and": [{
          "var": "_loops", "is": "GREATER", "value": "60"}
        ]
      },
      "actions": [{
        "type": "INFO", "value": "Force Attacking - Pause Detected (Turn: ${arena_turn})"}, {
        "type": "CALL", "value": "@tapUnit", "args": {"index": "${index_ayaka}"}}, {
        "type": "WAIT", "value": "1000"}, {
        "type": "BATCH", "value": "start"}, {
        "type": "CALL", "value": "@tapUnit", "args": {"index": "${index_malphasie1}"}}, {
        "type": "CALL", "value": "@tapUnit", "args": {"index": "${index_malphasie2}"}}, {
        "type": "CALL", "value": "@tapUnit", "args": {"index": "${index_lilith1}"}}, {
        "type": "CALL", "value": "@tapUnit", "args": {"index": "${index_lilith2}"}}, {
        "type": "BATCH", "value": "end"}, {
        "type": "WAIT", "value": "5000"}, {
        "type": "SET", "var": "stage", "value": "0"}, {
        "type": "ADD", "value": "1", "var": "arena_turn"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT", "value": ""}
      ]

    }, {

      "condition": {
        "is"    : "SCREEN", "value" : "game-battle",
        "and": [{
          "not": "SCREEN", "value": "game-battle-repeat"
        }]
      },
      "actions": [{
        "type": "WAIT", "value": "3000"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT"}
      ]
    }]
  },

  "_arena-battle-lb": {
    "name": "Arena - Battle - Fight (Override)",
    "description":"Continue fighting if every unit is fine, otherwise return to setup step.",
    "statements" : [{
      // --------------------------------------------------------------- //
      // ----------------------------- LB ------------------------------ //
      // --------------------------------------------------------------- //

      "condition": {
        "is": "CALL",
        "value": "@isBattleReady",
        "and": [{
          "is": "EQUAL", "value": "0", "var":"stage"}, {
          "is": "CALL", "value": "@isUnitReady", "args": {"index": "${index_ayaka}"} }, {
          "is": "CALL", "value": "@isUnitLbReady", "args": {"index": "${index_ayaka}"} }, {
          "not": "CALL", "value": "@isUnitLbSelected", "args": {"index": "${index_ayaka}"} }
        ]
      },
      "actions": [{
        "condition": {
          "not": "CALL", "value": "@readyUnitLbSafely", "args": {"index": "${index_ayaka}"}},
          "type": "CONTINUE"}, {
        "type": "WAIT", "value": "500"}, {
        "type": "INFO", "value": "Ayaka Use LB"}, {
        "type": "CALL", "value": "@tapUnit", "args": {"index": "${index_ayaka}"}}, {
        "type": "ADD", "value": "1", "var": "stage"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT"}
      ]

    }, {

      "condition": {
        "is": "CALL",
        "value": "@isBattleReady",
        "and": [{
          "is": "EQUAL", "value": "1", "var":"stage"}, {
          "is": "CALL", "value": "@isUnitReady", "args": {"index": "${index_lilith1}"} }, {
          "is": "CALL", "value": "@isUnitLbReady", "args": {"index": "${index_lilith1}"} }, {
          "not": "CALL", "value": "@isUnitLbSelected", "args": {"index": "${index_lilith1}"} }
        ]
      },
      "actions": [{
        "condition": {
          "not": "CALL", "value": "@readyUnitLbSafely", "args": {"index": "${index_lilith1}"}}, "type": "CONTINUE"}, {
        "type": "INFO", "value": "Lilith 1 Use LB"}, {
        "type": "ADD", "value": "1", "var": "stage"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT"}
      ]
    }, {

      "condition": {
        "is": "CALL",
        "value": "@isBattleReady",
        "and": [{
          "is": "EQUAL", "value": "2", "var":"stage"}, {
          "is": "CALL", "value": "@isUnitReady", "args": {"index": "${index_lilith2}"} }, {
          "is": "CALL", "value": "@isUnitLbReady", "args": {"index": "${index_lilith2}"} }, {
          "not": "CALL", "value": "@isUnitLbSelected", "args": {"index": "${index_lilith2}"} }
        ]
      },
      "actions": [{
        "condition": {
          "not": "CALL", "value": "@readyUnitLbSafely", "args": {"index": "${index_lilith2}"}}, "type": "CONTINUE"}, {
        "type": "INFO", "value": "Lilith 2 Use LB"}, {
        "type": "ADD", "value": "1", "var": "stage"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT"}
      ]
    }]
  },

  "_arena-battle-f": {
    "name": "Arena - Battle - Fight (Override)",
    "description":"Continue fighting if every unit is fine, otherwise return to setup step.",
    "statements" : [{

      // --------------------------------------------------------------- //
      // ------------------------------ 0 ------------------------------ //
      // --------------------------------------------------------------- //
      "condition": {
        "is": "CALL", "value": "@isBattleReady",
        "and": [{
          "is": "EQUAL", "value": "0", "var":"stage"}, {
          "is": "CALL", "value": "@isUnitReady", "args": {"index": "${index_ayaka}"} }, {
          "is": "CALL", "value": "@isUnitMpReady", "args": {"index": "${index_ayaka}"} }, {
          "not": "CALL", "value": "@isUnitMagicReady", "args": {"index": "${index_ayaka}"} }
        ],
        "andOr": [{
          "is": "SCREEN", "value": "battle-unit-${index_lilith1}_stop"}, {
          "is": "SCREEN", "value": "battle-unit-${index_lilith2}_stop"}, {
          "is": "SCREEN", "value": "battle-unit-${index_malphasie1}_stop"}, {
          "is": "SCREEN", "value": "battle-unit-${index_malphasie2}_stop"}
        ]
      },
      "actions": [{
        "type": "INFO", "value": "Stop has been detected, trying to resolve"}, {
        "type": "CALL", "value": "@ayaka-stopdetach", "args": {"index": "${index_ayaka}"}}, {
        "type": "WAIT", "value": "500"}, {
        "type": "CALL", "value": "@tapUnit", "args": {"index": "${index_ayaka}"}}, {
        "type": "ADD", "value": "1", "var": "stage"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT"}
      ]
    },{

      // Purify+
      "condition": {
        "is": "CALL", "value": "@isBattleReady",
        "and": [{
          "is": "EQUAL", "value": "0", "var":"stage"}, {
          "is": "CALL", "value": "@isUnitReady", "args": {"index": "${index_ayaka}"} }, {
          "is": "CALL", "value": "@isUnitMpReady", "args": {"index": "${index_ayaka}"} }, {
          "not": "CALL", "value": "@isUnitActionReady", "args": {"index": "${index_ayaka}"} }
        ]
      },
      "actions": [{
        "condition": {
          "not": "CALL", "value": "@ayaka-purify+", "args": {"index": "${index_ayaka}"}}, "type": "CONTINUE"}, {
        "type": "CALL", "value": "@tapUnit", "args": {"index": "${index_ayaka}"}}, {
        "type": "ADD", "value": "1", "var": "stage"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT"}
      ]
    }, {

      // Dedication
      "condition": {
        "is": "CALL", "value": "@isBattleReady",
        "and": [{
          "is": "EQUAL", "value": "0", "var":"stage"}, {
          "is": "CALL", "value": "@isUnitReady", "args": {"index": "${index_ayaka}"} }, {
          "is": "CALL", "value": "@isUnitMpReady", "args": {"index": "${index_ayaka}"} }, {
          "not": "CALL", "value": "@isUnitActionReady", "args": {"index": "${index_ayaka}"} }
        ],
        "andOr": [{
          "not": "CALL", "value": "@isUnitMpReady", "args": {"index": "${index_lilith1}"} }, {
          "not": "CALL", "value": "@isUnitMpReady", "args": {"index": "${index_lilith2}"} }, {
          "not": "CALL", "value": "@isUnitMpReady", "args": {"index": "${index_malphasie1}"} }, {
          "not": "CALL", "value": "@isUnitMpReady", "args": {"index": "${index_malphasie2}"} }
        ]
      },
      "actions": [{
        "type": "CALL", "value": "@ayaka-dedication", "args": {"index": "${index_ayaka}"}}, {
        "type": "CALL", "value": "@tapUnit", "args": {"index": "${index_lilith2}"}}, {
        "type": "WAIT", "value": "500"}, {
        "type": "CALL", "value": "@tapUnit", "args": {"index": "${index_ayaka}"}}, {
        "type": "ADD", "value": "1", "var": "stage"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT"}
      ]
    }, {

      "condition": {
        "is": "CALL", "value": "@isBattleReady",
        "and": [{
          "is": "EQUAL", "value": "0", "var":"stage"}, {
          "is": "CALL", "value": "@isUnitReady", "args": {"index": "${index_ayaka}"} }, {
          "is": "CALL", "value": "@isUnitMpReady", "args": {"index": "${index_ayaka}"} }, {
          "not": "CALL", "value": "@isUnitMagicReady", "args": {"index": "${index_ayaka}"} }
        ]
      },
      "actions": [{
        "type": "INFO", "value": "Healing team"}, {
        "type": "CALL", "value": "@ayaka-curaja", "args": {"index": "${index_ayaka}"}}, {
        "type": "WAIT", "value": "1000"}, {
        "type": "CALL", "value": "@tapUnit", "args": {"index": "${index_ayaka}"}}, {
        "type": "ADD", "value": "1", "var": "stage"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT"}
      ]
    }, {

      // --------------------------------------------------------------- //
      // ------------------------------ 1 ------------------------------ //
      // --------------------------------------------------------------- //

      "condition": {
        "is": "CALL", "value": "@isBattleReady",
        "and": [{
          "is": "EQUAL", "value": "1", "var":"stage"}, {
          "is": "CALL", "value": "@isUnitReady", "args": {"index": "${index_lilith1}"} }, {
          "is": "CALL", "value": "@isUnitMpReady", "args": {"index": "${index_lilith1}"} }, {
          "not": "CALL", "value": "@isUnitActionReady", "args": {"index": "${index_lilith1}"} }
        ]
      },
      "actions": [{
        "type": "CALL", "value": "@lilith-midnight", "args": {"index": "${index_lilith1}"}}, {
        "type": "ADD", "value": "1", "var": "stage"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT"}
      ]
    }, {

      // --------------------------------------------------------------- //
      // ------------------------------ 2 ------------------------------ //
      // --------------------------------------------------------------- //

      "condition": {
        "is": "CALL", "value": "@isBattleReady",
        "and": [{
          "is": "EQUAL", "value": "2", "var":"stage"}, {
          "is": "CALL", "value": "@isUnitReady", "args": {"index": "${index_lilith2}"} }, {
          "is": "CALL", "value": "@isUnitMpReady", "args": {"index": "${index_lilith2}"} }, {
          "not": "CALL", "value": "@isUnitActionReady", "args": {"index": "${index_lilith2}"} }
        ]
      },
      "actions": [{
        "type": "CALL", "value": "@lilith-midnight", "args": {"index": "${index_lilith2}"}}, {
        "type": "ADD", "value": "1", "var": "stage"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT"}
      ]
    }, {

      // --------------------------------------------------------------- //
      // ------------------------------ 3 ------------------------------ //
      // --------------------------------------------------------------- //
      "condition": {
        "is": "CALL", "value": "@isBattleReady",
        "and": [{
          "is": "EQUAL", "value": "3", "var":"stage"}, {
          "is": "CALL", "value": "@isUnitReady", "args": {"index": "${index_malphasie1}"} }, {
          "is": "CALL", "value": "@isUnitMpReady", "args": {"index": "${index_malphasie1}"} }, {
          "not": "CALL", "value": "@isUnitActionReady", "args": {"index": "${index_malphasie1}"} }
        ]
      },
      "actions": [{
        "type": "CALL", "value": "@malphasie-fiendishwinds", "args": {"index": "${index_malphasie1}"}}, {
        "type": "ADD", "value": "1", "var": "stage"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT"}
      ]

    }, {

      // --------------------------------------------------------------- //
      // ------------------------------ 4 ------------------------------ //
      // --------------------------------------------------------------- //
      "condition": {
        "is": "CALL", "value": "@isBattleReady",
        "and": [{
          "is": "EQUAL", "value": "4", "var":"stage"}, {
          "is": "CALL", "value": "@isUnitReady", "args": {"index": "${index_malphasie2}"} }, {
          "is": "CALL", "value": "@isUnitMpReady", "args": {"index": "${index_malphasie2}"} }, {
          "not": "CALL", "value": "@isUnitActionReady", "args": {"index": "${index_malphasie2}"} }
        ]
      },
      "actions": [{
        "type": "CALL", "value": "@malphasie-fiendishwinds", "args": {"index": "${index_malphasie2}"}}, {
        "type": "ADD", "value": "1", "var": "stage"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT"}
      ]

    }, {

      // --------------------------------------------------------------- //
      // --------------------------- Attack ---------------------------- //
      // --------------------------------------------------------------- //
      "condition": {
        "is": "EQUAL", "value": "5", "var":"stage"
      },
      "actions": [{
        "type": "INFO", "value": "Attacking (Turn: ${arena_turn})"}, {
        "type": "CALL", "value": "@tapUnit", "args": {"index": "${index_ayaka}"}}, {
        "type": "WAIT", "value": "1000"}, {
        "type": "BATCH", "value": "start"}, {
        "type": "TAP", "value": "battle-unit_${index_lilith1}"}, {
        "type": "TAP", "value": "battle-unit_${index_lilith2}"}, {
        "type": "TAP", "value": "battle-unit_${index_malphasie1}"}, {
        "type": "TAP", "value": "battle-unit_${index_malphasie2}"}, {
        "type": "BATCH", "value": "end"}, {
        "type": "WAIT", "value": "5000"}, {
        "type": "SET", "value": "0", "var": "stage"}, {
        "type": "ADD", "value": "1", "var": "arena_turn"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT"}
      ]

    }, {

      "condition": {
        "is": "GREATER", "value": "5", "var": "stage"
      },
      "actions": [{
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "SET", "value": "0", "var": "stage"}, {
        "type": "REPEAT", "value": ""}
      ]
    }]
  },

  "arena-battle-fight": {
    "name": "Arena - Battle - Fight (Override)",
    "description":"Continue fighting if every unit is fine, otherwise return to setup step.",
    "includes": [
      "_arena-battle-fight",
      "_common-no_op"
    ]
    }
  }
}