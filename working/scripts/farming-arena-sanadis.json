//@formatter:off
{
"vars": [],
"imports": [
  "ayaka",
  "veritas",
  "orlandeau",
  "malphasie",
  "freyvia",
  "rinoa"
],
"states": {

  "_arena-menu-opponent-select": {
  "statements" : [{
      "condition": {
        "is": "SCREEN", "value": "menu-arena-opponent_select"
      },
      "actions": [{
        "type": "SLOW_UP", "value": "menu-arena-opponent_drag"}, {
        "type": "SLOW_UP", "value": "menu-arena-opponent_drag"}, {
        "type": "SLOW_UP", "value": "menu-arena-opponent_drag"}, {
        "type": "TAP", "value": "menu-arena-opponent_first"}, {
        "type": "WAIT", "value": "2000"}, {
        "type": "REPEAT", "value": ""}
      ]
    }]
  },

  "arena-battle-setup": {
    "name": "Arena - Battle - Setup (Override)",
    "description":"Setup each unit and start the fight",
    "includes": [
      "_arena-battle-fight",
      "_common-no_op"
    ],
    "variables": {
       "index_votd": {"value": "0", "type": "INT"},
       "index_orlandeau": {"value": "1", "type": "INT"},
       "index_malphasie": {"value": "2", "type": "INT"},
       "index_malphasie2": {"value": "3", "type": "INT"},
       "index_ayaka": {"value": "4", "type": "INT"},

       "stage": {"value": "0", "type": "INT"},
       "arena_turn": {"value": "1", "type": "INT"},
       "elysium": {"value": "0", "type": "INT"},
       "purify": {"value": "0", "type": "INT"},
       "availableUnits": {"value": "0", "type": "INT"},
       "modified": {"value": "0", "type": "INT"},
       "lbAttempts": {"value": "0", "type": "INT"}
    },
    "statements": [{

      "condition": {
        "is": "CALL", "value": "@isBattleReady",
        "and": [{
          "is": "LESS", "value": "5", "var": "stage"}, {
          "is": "GREATER", "value": "15", "var": "_loops" }
        ]
      },
      "actions": [{
        "type": "INFO", "value": "Unit stuck on stage ${stage}, incrementing counter"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "ADD", "value": "1", "var": "stage"}, {
        "type": "REPEAT", "value": ""}
      ]

    }, {

      "condition": {
        "is"    : "SCREEN", "value" : "game-battle",
        "and": [{
          "var": "_loops", "is": "GREATER", "value": "60"}
        ]
      },
      "actions": [{
        "type": "INFO", "value": "Force Attacking - Pause Detected (Turn: ${arena_turn})"}, {
        "type": "CALL", "value": "@tapUnit", "args": {"index": "${index_ayaka}"}}, {
        "type": "WAIT", "value": "1000"}, {
        "type": "BATCH", "value": "start"}, {
        "type": "TAP", "value": "battle-unit_${index_malphasie}"}, {
        "type": "TAP", "value": "battle-unit_${index_malphasie2}"}, {
        "type": "TAP", "value": "battle-unit_${index_votd}"}, {
        "type": "TAP", "value": "battle-unit_${index_orlandeau}"}, {
        "type": "BATCH", "value": "end"}, {
        "type": "WAIT", "value": "5000"}, {
        "type": "SET", "var": "stage", "value": "0"}, {
        "type": "ADD", "value": "1", "var": "arena_turn"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT", "value": ""}
      ]

    }, {

      "condition": {
        "is"    : "SCREEN", "value" : "game-battle",
        "and": [{
          "not": "SCREEN", "value": "game-battle-repeat"
        }]
      },
      "actions": [{
        "type": "WAIT", "value": "3000"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT"}
      ]

    }, {

      // --------------------------------------------------------------- //
      // ---------------------------- Ayaka ---------------------------- //
      // --------------------------------------------------------------- //
      "condition": {
        "is": "CALL", "value": "@isBattleReady",
        "and": [{
          "is": "EQUAL", "value": "0", "var":"stage"}, {
          "is": "CALL", "value": "@isUnitReady", "args": {"index": "${index_ayaka}"} }, {
          "is": "CALL", "value": "@isUnitLbReady", "args": {"index": "${index_ayaka}"} }, {
          "not": "CALL", "value": "@isUnitLbSelected", "args": {"index": "${index_ayaka}"} }
        ]
      },
      "actions": [{
        "type": "INFO", "value": "Ayaka Limit Burst"}, {
        "type": "CALL", "value": "@readyUnitLb", "args": {"index": "${index_ayaka}"}}, {
        "type": "WAIT", "value": "1000"}, {
        "type": "CALL", "value": "@tapUnit", "args": {"index": "${index_ayaka}"}}, {
        "type": "ADD", "value": "1", "var": "stage"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT"}
      ]

    }, {

      "condition": {
        "is": "CALL", "value": "@isBattleReady",
        "and": [{
          "is": "EQUAL", "value": "0", "var":"stage"}, {
          "is": "CALL", "value": "@isUnitReady", "args": {"index": "${index_ayaka}"} }, {
          "is": "CALL", "value": "@isUnitMpReady", "args": {"index": "${index_ayaka}"} }, {
          "not": "CALL", "value": "@isUnitMagicReady", "args": {"index": "${index_ayaka}"} }
        ],
        "andOr": [{
          "is": "SCREEN", "value": "battle-unit-${index_votd}_stop"}, {
          "is": "SCREEN", "value": "battle-unit-${index_orlandeau}_stop"}, {
          "is": "SCREEN", "value": "battle-unit-${index_malphasie}_stop"}, {
          "is": "SCREEN", "value": "battle-unit-${index_malphasie2}_stop"}
        ]
      },
      "actions": [{
        "type": "INFO", "value": "Stop has been detected, trying to resolve"}, {
        "type": "CALL", "value": "@ayaka-stopdetach", "args": {"index": "${index_ayaka}"}}, {
        "type": "WAIT", "value": "1000"}, {
        "type": "CALL", "value": "@tapUnit", "args": {"index": "${index_ayaka}"}}, {
        "type": "ADD", "value": "1", "var": "stage"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT"}
      ]
    }, {

      "condition": {
        "is": "CALL", "value": "@isBattleReady",
        "and": [{
          "is": "EQUAL", "value": "0", "var":"stage"}, {
          "is": "CALL", "value": "@isUnitReady", "args": {"index": "${index_ayaka}"} }, {
          "is": "CALL", "value": "@isUnitMpReady", "args": {"index": "${index_ayaka}"} }, {
          "not": "CALL", "value": "@isUnitMagicReady", "args": {"index": "${index_ayaka}"} }
        ]
      },
      "actions": [{
        "type": "INFO", "value": "Healing team"}, {
        "type": "CALL", "value": "@ayaka-curaja", "args": {"index": "${index_ayaka}"}}, {
        "type": "WAIT", "value": "1000"}, {
        "type": "CALL", "value": "@tapUnit", "args": {"index": "${index_ayaka}"}}, {
        "type": "ADD", "value": "1", "var": "stage"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT"}
      ]
    }, {

      // --------------------------------------------------------------- //
      // ---------------------------- VOTD ----------------------------- //
      // --------------------------------------------------------------- //
      "condition": {
        "is": "CALL", "value": "@isBattleReady",
        "and": [{
          "is": "EQUAL", "value": "1", "var":"stage"}, {
          "is": "CALL", "value": "@isUnitReady", "args": {"index": "${index_votd}"} }, {
          "is": "CALL", "value": "@isUnitMpReady", "args": {"index": "${index_votd}"} }, {
          "not": "CALL", "value": "@isUnitActionReady", "args": {"index": "${index_votd}"} }
        ]
      },
      "actions": [{
        "type": "CALL", "value": "@veritas-punishment", "args": {"index": "${index_votd}"}}, {
        "type": "ADD", "value": "1", "var": "stage"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT"}
      ]
    }, {

      // --------------------------------------------------------------- //
      // -------------------------- Orlandeau -------------------------- //
      // --------------------------------------------------------------- //
//      "condition": {
//        "is": "CALL", "value": "@isBattleReady",
//        "and": [{
//          "is": "EQUAL", "value": "2", "var":"stage"}, {
//          "is": "CALL", "value": "@isUnitReady", "args": {"index": "${index_orlandeau}"} }, {
//          "is": "CALL", "value": "@isUnitLbReady", "args": {"index": "${index_orlandeau}"} }, {
//          "not": "CALL", "value": "@isUnitLbSelected", "args": {"index": "${index_orlandeau}"} }
//        ]
//      },
//      "actions": [{
//        "type": "INFO", "value": "Orlandeau Limit Burst"}, {
//        "type": "CALL", "value": "@readyUnitLb", "args": {"index": "${index_orlandeau}"}}, {
//        "type": "CALL", "value": "@tapUnit", "args": {"index": "${index_orlandeau}"}}, {
//        "type": "ADD", "value": "1", "var": "stage"}, {
//        "type": "CALL", "value": "@keepAlive"}, {
//        "type": "REPEAT"}
//      ]
//
//    }, {

      "condition": {
        "is": "CALL", "value": "@isBattleReady",
        "and": [{
          "is": "EQUAL", "value": "2", "var":"stage"}, {
          "is": "CALL", "value": "@isUnitReady", "args": {"index": "${index_orlandeau}"} }, {
          "is": "CALL", "value": "@isUnitMpReady", "args": {"index": "${index_orlandeau}"} }, {
          "not": "CALL", "value": "@isUnitActionReady", "args": {"index": "${index_orlandeau}"} }
        ]
      },
      "actions": [{
        "type": "CALL", "value": "@orlandeau-dr", "args": {"index": "${index_orlandeau}"}}, {
        "type": "ADD", "value": "1", "var": "stage"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT"}
      ]
    }, {

      // --------------------------------------------------------------- //
      // ------------------------- Malphasie 1 ------------------------- //
      // --------------------------------------------------------------- //
      "condition": {
        "is": "CALL", "value": "@isBattleReady",
        "and": [{
          "is": "EQUAL", "value": "3", "var":"stage"}, {
          "is": "CALL", "value": "@isUnitReady", "args": {"index": "${index_malphasie}"} }, {
          "is": "CALL", "value": "@isUnitMpReady", "args": {"index": "${index_malphasie}"} }, {
          "not": "CALL", "value": "@isUnitActionReady", "args": {"index": "${index_malphasie}"} }, {
          "var": "arena_turn", "not": "GREATER",  "value": "2"}
        ]
      },
      "actions": [{
        "type": "CALL", "value": "@malphasie-fiendishwinds", "args": {"index": "${index_malphasie}"}}, {
        "type": "ADD", "value": "1", "var": "stage"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT"}
      ]

    }, {

      "condition": {
        "is": "CALL", "value": "@isBattleReady",
        "and": [{
          "is": "EQUAL", "value": "3", "var":"stage"}, {
          "is": "CALL", "value": "@isUnitReady", "args": {"index": "${index_malphasie}"} }, {
          "is": "CALL", "value": "@isUnitMpReady", "args": {"index": "${index_malphasie}"} }, {
          "not": "CALL", "value": "@isUnitActionReady", "args": {"index": "${index_malphasie}"} }, {
          "var": "arena_turn", "is": "GREATER",  "value": "2"}
        ]
      },
      "actions": [{
        "type": "CALL", "value": "@malphasie-thousandwings", "args": {"index": "${index_malphasie}"}}, {
        "type": "ADD", "value": "1", "var": "stage"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT"}
      ]

    }, {

      // --------------------------------------------------------------- //
      // ------------------------- Malphasie 2 ------------------------- //
      // --------------------------------------------------------------- //
      "condition": {
        "is": "CALL", "value": "@isBattleReady",
        "and": [{
          "is": "EQUAL", "value": "4", "var":"stage"}, {
          "is": "CALL", "value": "@isUnitReady", "args": {"index": "${index_malphasie2}"} }, {
          "is": "CALL", "value": "@isUnitMpReady", "args": {"index": "${index_malphasie2}"} }, {
          "not": "CALL", "value": "@isUnitActionReady", "args": {"index": "${index_malphasie2}"} }, {
          "var": "arena_turn", "not": "GREATER",  "value": "2"}
        ]
      },
      "actions": [{
        "type": "CALL", "value": "@malphasie-fiendishwinds", "args": {"index": "${index_malphasie2}"}}, {
        "type": "ADD", "value": "1", "var": "stage"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT"}
      ]

    }, {

      "condition": {
        "is": "CALL", "value": "@isBattleReady",
        "and": [{
          "is": "EQUAL", "value": "4", "var":"stage"}, {
          "is": "CALL", "value": "@isUnitReady", "args": {"index": "${index_malphasie2}"} }, {
          "is": "CALL", "value": "@isUnitMpReady", "args": {"index": "${index_malphasie2}"} }, {
          "not": "CALL", "value": "@isUnitActionReady", "args": {"index": "${index_malphasie2}"} }, {
          "var": "arena_turn", "is": "GREATER",  "value": "2"}
        ]
      },
      "actions": [{
        "type": "CALL", "value": "@malphasie-thousandwings", "args": {"index": "${index_malphasie2}"}}, {
        "type": "ADD", "value": "1", "var": "stage"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT"}
      ]

    }, {

      // --------------------------------------------------------------- //
      // --------------------------- Attack ---------------------------- //
      // --------------------------------------------------------------- //
      "condition": {
        "is": "EQUAL", "value": "5", "var":"stage"
      },
      "actions": [{
        "type": "INFO", "value": "Attacking (Turn: ${arena_turn})"}, {
        "type": "CALL", "value": "@tapUnit", "args": {"index": "${index_ayaka}"}}, {
        "type": "WAIT", "value": "1000"}, {
        "type": "BATCH", "value": "start"}, {
        "type": "TAP", "value": "battle-unit_${index_malphasie}"}, {
        "type": "TAP", "value": "battle-unit_${index_malphasie2}"}, {
        "type": "TAP", "value": "battle-unit_${index_votd}"}, {
        "type": "TAP", "value": "battle-unit_${index_orlandeau}"}, {
        "type": "BATCH", "value": "end"}, {
        "type": "WAIT", "value": "5000"}, {
        "type": "SET", "value": "0", "var": "stage"}, {
        "type": "ADD", "value": "1", "var": "arena_turn"}, {
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "REPEAT"}
      ]

    }, {

      "condition": {
        "is": "GREATER", "value": "5", "var": "stage"
      },
      "actions": [{
        "type": "CALL", "value": "@keepAlive"}, {
        "type": "SET", "value": "0", "var": "stage"}, {
        "type": "REPEAT", "value": ""}
      ]

    }]
  },

  "arena-battle-fight": {
    "name": "Arena - Battle - Fight (Override)",
    "description":"Continue fighting if every unit is fine, otherwise return to setup step.",
    "includes": [
      "_arena-battle-fight",
      "_common-no_op"
    ]
    }
  }
}